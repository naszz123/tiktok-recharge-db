<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TikTok Coins Recharge</title>
<style>
  /* ... (style tetap sama, tidak diubah) ... */
</style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <img src="https://files.catbox.moe/0tudk3.png" alt="TikTok Logo" />
      TikTok
    </div>
    <div class="search-container"><input type="search" placeholder="Search" /></div>
    <button onclick="logout()" style="margin-left:10px; padding:6px 12px; background:#ff2a5f; color:white; border:none; border-radius:18px; cursor:pointer;">Logout</button>  <!-- Dipindahkan ke header -->
  </div>

  <main class="content" role="main">
    <!-- ... (konten tetap sama) ... -->
    <div class="packages" id="packages">
      <!-- ... (packages tetap sama) ... -->
      <div class="package" data-coins="custom" data-price="custom">
        <img class="coin-icon" src="https://files.catbox.moe/nlykhs.jpeg" alt="coin">
        <div class="package-amount">Custom</div>
        <div class="package-price">Large amount supported</div>
        <!-- INPUT CUSTOM (tampilkan saat klik) -->
        <input 
          id="customInput" 
          type="number" 
          inputmode="numeric"
          placeholder="Masukkan jumlah"
          style="margin-top:8px; padding:8px; border-radius:10px; width:90%; display:none;"
        >
      </div>
    </div>
    <!-- ... (payment dan button tetap sama) ... -->
  </main>

  <!-- Popups tetap sama -->
  <!-- ... -->

  <!-- MUSIC tetap sama -->
  <!-- ... -->

<script>
/* ====== Music popup & player (tetap sama) ====== */
/* ... */

/* ====== Custom Package Logic (diperbaiki: hapus duplikasi, gabungkan logika) ====== */
let customTarget = null;

const pkgEls = document.querySelectorAll('.package');
let selectedPackage = null;

pkgEls.forEach(p => {
  p.addEventListener('click', () => {
    pkgEls.forEach(x => x.classList.remove('active'));
    p.classList.add('active');

    // CUSTOM MODE
    if (p.dataset.coins === "custom") {
      const customInput = document.getElementById('customInput');
      customInput.style.display = "block";
      customInput.focus();
      customTarget = p;  // Simpan target untuk update

      customInput.addEventListener("input", () => {
        const val = customInput.value.trim();
        if (!val || isNaN(val) || Number(val) <= 0) return;

        // Update tampilan langsung
        p.querySelector(".package-amount").innerText = val;
        p.querySelector(".package-price").innerText = "$ -";

        selectedPackage = {
          coins: val,
          price: "Custom"
        };
      });
      return;
    }

    // NORMAL PACKAGE
    document.getElementById('customInput').style.display = "none";
    selectedPackage = {
      coins: p.dataset.coins,
      price: p.dataset.price
    };
  });
});

/* ====== Recharge Logic (diperbaiki: gunakan 'user', tambahkan user.username, error handling) ====== */
const rechargeBtn = document.getElementById('rechargeBtn');
const loadingPopup = document.getElementById('loadingPopup');
const paymentPopup = document.getElementById('paymentPopup');
const userInfoPopup = document.getElementById('userInfoPopup');
const popupText = document.getElementById('popupText');
const progressBar = document.getElementById('progress');

function show(el){ el.style.display = 'flex'; el.setAttribute('aria-hidden','false'); }
function hide(el){ el.style.display = 'none'; el.setAttribute('aria-hidden','true'); }

rechargeBtn.addEventListener('click', ()=>{
  const username = document.getElementById('username').value.trim();
  if(!username){ alert('Please enter your username.'); return; }
  if(!selectedPackage){ alert('Please select a coin package.'); return; }

  // Ambil user dari localStorage dan gunakan user.username
  const userData = localStorage.getItem('user');
  if (!userData) {
    alert('Please log in first.');
    window.location.href = 'login.html';
    return;
  }
  const user = JSON.parse(userData);  // Parse user data
  // Gunakan user.username, e.g., tampilkan di alert atau popup
  alert(`Recharging for logged-in user: ${user.username}`);

  rechargeBtn.disabled = true;
  rechargeBtn.innerText = 'Processing...';
  progressBar.style.width = '0%';
  show(loadingPopup);

  let progress = 0;
  const steps = 20;
  const interval = 2000 / steps;
  const inc = 100 / steps;
  const t = setInterval(()=>{
    progress += inc;
    if(progress > 100) progress = 100;
    progressBar.style.width = progress + '%';
    if(progress >= 100){
      clearInterval(t);
      hide(loadingPopup);
      rechargeBtn.disabled = false;
      rechargeBtn.innerText = 'Recharge';
      popupText.innerText = `The coin worth $${selectedPackage.price} has been charged for user ${user.username}.`;  // Tambahkan user.username di popup
      show(paymentPopup);
    }
  }, interval);
});

/* ... (event listeners lainnya tetap sama) ... */

// Check if user is logged in (using localStorage for session)
const isLoggedIn = localStorage.getItem('user');
if (!isLoggedIn) {
  window.location.href = 'login.html'; // Redirect to login page
}

// Function to handle logout
function logout() {
  localStorage.removeItem('user');
  window.location.href = 'login.html';
}
</script>

<footer style="text-align:center; margin:28px 0 8px 0; color:#888; font-size:13px;">Â© Powered By Tiktok Indonesia</footer>
</body>
  </html>
